# üìù –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

## üéØ –û–±–∑–æ—Ä

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ —Å:
- ‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π** - —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤—ã
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ—Å—á–µ—Ç–æ–º —Ä–µ–π—Ç–∏–Ω–≥–∞** - —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –æ—Ç–∑—ã–≤–µ
- ‚úÖ **Firestore –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Firestore
- ‚úÖ **–ö—Ä–∞—Å–∏–≤—ã–º UI** - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–≤–µ–∑–¥—ã, –∞–Ω–∏–º–∞—Ü–∏–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ö–æ–ª–ª–µ–∫—Ü–∏—è `reviews`

```javascript
{
  companyId: "company_document_id",       // ID –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ companies
  userId: "firebase_user_uid",            // UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firebase Auth
  userName: "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",           // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
  userEmail: "user@example.com",          // Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  rating: 5,                              // –û—Ü–µ–Ω–∫–∞ –æ—Ç 1 –¥–æ 5
  comment: "–û—Ç–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å!",            // –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ (10-1000 —Å–∏–º–≤–æ–ª–æ–≤)
  createdAt: Timestamp                    // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `companies`

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–ª—è:

```javascript
{
  rating: 4.5,                // –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ (–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è)
  reviewsCount: 12,           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤
  updatedAt: Timestamp        // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
}
```

## üîê Firestore Security Rules

–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ `firestore.rules`:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reviews collection
    match /reviews/{reviewId} {
      // –í—Å–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –æ—Ç–∑—ã–≤—ã
      allow read: if true;
      
      // –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–∑—ã–≤—ã
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5
                    && request.resource.data.comment.size() >= 10
                    && request.resource.data.comment.size() <= 1000;
      
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –æ—Ç–∑—ã–≤—ã
      allow update: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
      
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –æ—Ç–∑—ã–≤—ã
      // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –ª—é–±—ã–µ –æ—Ç–∑—ã–≤—ã
      allow delete: if request.auth != null 
                    && (resource.data.userId == request.auth.uid 
                        || request.auth.token.email == 'admin@kontrollitud.ee');
    }
    
    // Companies collection - allow rating updates
    match /companies/{companyId} {
      allow read: if true;
      
      // –†–∞–∑—Ä–µ—à–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏–∑ frontend
      allow update: if request.auth != null
                    && (
                      // –¢–æ–ª—å–∫–æ –ø–æ–ª—è rating, reviewsCount, updatedAt –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω—ã
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['rating', 'reviewsCount', 'updatedAt'])
                    );
    }
  }
}
```

## üì• Firestore Index

–î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –Ω—É–∂–µ–Ω composite index:

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–º–ø–∞–Ω–∏–∏
3. –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—è–≤–∏—Ç—Å—è –æ—à–∏–±–∫–∞ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
4. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è Firebase Console
5. –ù–∞–∂–º–∏—Ç–µ **Create Index**

### –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ (Firebase Console):

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Firestore Database** ‚Üí **Indexes** ‚Üí **Composite**
2. –ù–∞–∂–º–∏—Ç–µ **Create Index**
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ:
   - Collection ID: `reviews`
   - Fields to index:
     - `companyId` - Ascending
     - `createdAt` - Descending
   - Query scope: Collection
4. –ù–∞–∂–º–∏—Ç–µ **Create**

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ CLI:

```bash
firebase firestore:indexes
```

–î–æ–±–∞–≤—å—Ç–µ –≤ `firestore.indexes.json`:

```json
{
  "indexes": [
    {
      "collectionGroup": "reviews",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "companyId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    }
  ]
}
```

–ó–∞—Ç–µ–º:

```bash
firebase deploy --only firestore:indexes
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö:

```jsx
import ReviewForm from './ReviewForm';

function CompanyDetails() {
  const [reviews, setReviews] = useState([]);
  
  const handleReviewAdded = (newReview) => {
    setReviews([newReview, ...reviews]);
    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç —Ä–µ–π—Ç–∏–Ω–≥ –∫–æ–º–ø–∞–Ω–∏–∏
  };
  
  return (
    <div>
      <ReviewForm 
        companyId={company.id} 
        onReviewAdded={handleReviewAdded} 
      />
      
      {/* –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ */}
      <div className="reviews-list">
        {reviews.map(review => (
          <ReviewItem key={review.id} review={review} />
        ))}
      </div>
    </div>
  );
}
```

## üé® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ UI

### –î–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö:
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤"
- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ —Å –∏–∫–æ–Ω–∫–æ–π
- –ó–≤–µ–∑–¥—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã

### –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö:
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–≤–µ–∑–¥—ã —Å hover —ç—Ñ—Ñ–µ–∫—Ç–æ–º
- –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ (10-1000)
- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
```bash
# –ë–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞
# –° –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π - –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è —Ñ–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞:
```javascript
// –î–æ –æ—Ç–∑—ã–≤–∞:
// rating: 4.0, reviewsCount: 10

// –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º 5
// –ü–æ—Å–ª–µ –æ—Ç–∑—ã–≤–∞:
// rating: (4.0 * 10 + 5) / 11 = 4.09
// reviewsCount: 11
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Firestore Rules:
```bash
# –í Firebase Console ‚Üí Firestore ‚Üí Rules ‚Üí Playground
# –¢–µ—Å—Ç 1: –ß—Ç–µ–Ω–∏–µ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - ‚úÖ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
# –¢–µ—Å—Ç 2: –°–æ–∑–¥–∞–Ω–∏–µ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - ‚ùå –∑–∞–ø—Ä–µ—â–µ–Ω–æ
# –¢–µ—Å—Ç 3: –°–æ–∑–¥–∞–Ω–∏–µ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π - ‚úÖ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
```

## üîß –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤:

```jsx
const handleEditReview = async (reviewId, newComment, newRating) => {
  const reviewRef = doc(db, 'reviews', reviewId);
  await updateDoc(reviewRef, {
    comment: newComment,
    rating: newRating,
    updatedAt: serverTimestamp()
  });
  
  // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –∫–æ–º–ø–∞–Ω–∏–∏
  await recalculateCompanyRating(companyId);
};
```

### –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é:

```javascript
const fetchReviews = async (lastVisible = null, limit = 10) => {
  let q = query(
    collection(db, 'reviews'),
    where('companyId', '==', companyId),
    orderBy('createdAt', 'desc'),
    limit(limit)
  );
  
  if (lastVisible) {
    q = query(q, startAfter(lastVisible));
  }
  
  const snapshot = await getDocs(q);
  const reviews = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
  
  const lastDoc = snapshot.docs[snapshot.docs.length - 1];
  return { reviews, lastVisible: lastDoc };
};
```

## üì± –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è

–°—Ç–∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è:
- –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö: —Å—Ç–µ–∫-–ª–µ–π–∞—É—Ç
- –ù–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö: –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞
- –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ: –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —Å –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ò–Ω–¥–µ–∫—Å—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã** - –±–µ–∑ –Ω–∏—Ö –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
2. **Security Rules –∫—Ä–∏—Ç–∏—á–Ω—ã** - –∑–∞—â–∏—â–∞—é—Ç –æ—Ç –Ω–∞–∫—Ä—É—Ç–æ–∫ –∏ —Å–ø–∞–º–∞
3. **Toast notifications** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω ToastContainer
4. **AuthContext** - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±–µ—Ä–Ω—É—Ç –≤–æ–∫—Ä—É–≥ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –≤–∞—à —Å–∞–π—Ç –∏–º–µ–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –æ—Ç–∑—ã–≤–æ–≤ —Å:
- –ó–∞—â–∏—Ç–æ–π –æ—Ç –Ω–∞–∫—Ä—É—Ç–æ–∫ (—Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç)
- –ö—Ä–∞—Å–∏–≤—ã–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º UI
- –†–µ–∞–ª—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
