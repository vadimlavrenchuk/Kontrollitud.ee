rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email == 'vadim5239@gmail.com';
    }
    
    // Public read access to approved companies
    match /companies/{companyId} {
      // Anyone can read approved companies
      allow read: if true;
      
      // Authenticated users can create approved companies (auto-moderation passed)
      // Admins can create any company
      allow create: if isAuthenticated() && 
                       (request.resource.data.status == 'approved' || isAdmin());
      
      // Admins can update or delete companies
      // Also allow rating updates from review system
      allow update: if isAdmin() || 
                       (isAuthenticated() && 
                        request.resource.data.diff(resource.data).affectedKeys()
                          .hasOnly(['rating', 'reviewsCount', 'updatedAt']));
      
      allow delete: if isAdmin();
    }
    
    // Pending companies - waiting for admin approval
    match /pending_companies/{companyId} {
      // Admins can read all, users can read their own
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      
      // Any authenticated user can create pending companies
      allow create: if isAuthenticated();
      
      // Only owner or admin can update
      allow update: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin());
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      // Anyone can read approved reviews
      allow read: if resource.data.status == 'approved' || isAdmin();
      
      // Only authenticated users can create reviews
      // Validate review data with moderation requirements
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.rating >= 1 &&
                       request.resource.data.rating <= 5 &&
                       request.resource.data.comment.size() >= 10 &&
                       request.resource.data.comment.size() <= 2000 &&
                       // Status must be one of: approved, pending, needs_review, rejected
                       request.resource.data.status in ['approved', 'pending', 'needs_review', 'rejected'] &&
                       // No URLs allowed (basic check)
                       !request.resource.data.comment.matches('.*https?://.*') &&
                       !request.resource.data.comment.matches('.*www\\..*');
      
      // Only admin can update reviews (for moderation)
      allow update: if isAdmin();
      
      // Only admin can delete reviews
      allow delete: if isAdmin();
    }
    
    // Admin users collection
    match /admins/{userId} {
      // Only the user themselves or other admins can read
      allow read: if isAuthenticated() && 
                     (request.auth.uid == userId || isAdmin());
      
      // Only existing admins can create new admins
      allow create, update, delete: if isAdmin();
    }
    
    // User profiles
    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isAuthenticated() && 
                     (request.auth.uid == userId || isAdmin());
      
      // Users can create/update their own profile
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      
      // Only admins can delete profiles
      allow delete: if isAdmin();
    }
    
    // Blog posts
    match /blog_posts/{postId} {
      // Anyone can read published posts
      allow read: if true;
      
      // Only admins can create, update, delete posts
      allow create, update, delete: if isAdmin();
    }
    
    // Site statistics
    match /stats/{document} {
      // Anyone can read stats (for visit tracking)
      allow read: if true;
      
      // Anyone can write (for visit tracking, but validate in app logic)
      allow write: if true;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
